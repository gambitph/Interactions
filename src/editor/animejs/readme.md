# Our Customized Anime.js

We need to have our own customized build of Anime.js script because there are
some things that cannot be extended and we have to resort to adding our own
changes manually.

https://github.com/juliangarnier/anime

# Updating

Copy the original anime.js file from
https://github.com/juliangarnier/anime/blob/master/lib/anime.es.js into the
local index.js

# Customizations Added for Interactions

## 1. Add `!important` to styles

We need to add `!important` to styles generated by AnimeJS and so far this is not yet supported.

```diff
tweenStyle = /** @type {DOMTarget} */( tweenTarget ).style
if ( tweenType === tweenTypes.TRANSFORM ) {
	if ( tweenTarget !== tweenTargetTransforms ) {
		tweenTargetTransforms = tweenTarget
		// NOTE: Referencing the cachedTransforms in the tween property directly can be a little bit faster but appears to increase memory usage.
		tweenTargetTransformsProperties = tweenTarget[ transformsSymbol ]
	}
	tweenTargetTransformsProperties[ tweenProperty ] = value
	tweenTransformsNeedUpdate = 1
} else if ( tweenType === tweenTypes.CSS ) {
-	tweenStyle[ tweenProperty ] = value
+	tweenStyle.setProperty( tweenProperty, value, 'important' )
} else if ( tweenType === tweenTypes.CSS_VAR ) {
	tweenStyle.setProperty( tweenProperty, /** @type {string} */( value ) )
}
```

and

```diff
if ( tweenTransformsNeedUpdate && tween._renderTransforms ) {
	let str = emptyString
	for ( const key in tweenTargetTransformsProperties ) {
		str += `${ transformsFragmentStrings[ key ] }${ tweenTargetTransformsProperties[ key ] }) `
	}
-	tweenStyle.transform = str
+	tweenStyle.setProperty( 'transform', str, 'important' )
	tweenTransformsNeedUpdate = 0
}
```

## 2. We move all the `perspective` transform values to the start of the transform

If `perspective` is used on multiple timelines, then its position in a `transform` style rule can be in the middle or end. We need to make sure it's in the start:

```diff
if ( tweenTransformsNeedUpdate && tween._renderTransforms ) {
	let str = emptyString
+	// Move perspective to the front of the string
+	if ( 'perspective' in tweenTargetTransformsProperties ) {
+		str = `perspective(${ tweenTargetTransformsProperties.perspective }) ${ str }`
+		// Remove perspective
+		delete tweenTargetTransformsProperties.perspective
+	}
	for ( const key in tweenTargetTransformsProperties ) {
		str += `${ transformsFragmentStrings[ key ] }${ tweenTargetTransformsProperties[ key ] }) `
	}
	tweenStyle.transform = str
	tweenTransformsNeedUpdate = 0
}
```

## 3. We fixed the lag when scrubbing video

If animating a video, adjusting `currentTime` a lot of times makes things laggy, we need to only do this when the video is not seeking

```diff
if ( tweenType === tweenTypes.OBJECT ) {
-    tweenTarget[ tweenProperty ] = value
+    if ( tweenProperty === 'currentTime' ) {
+        if ( ! tweenTarget.seeking ) {
+            tweenTarget[ tweenProperty ] = value
+        }
+    } else {
+        tweenTarget[ tweenProperty ] = value
+    }
} else if ( tweenType === tweenTypes.ATTRIBUTE ) {
```